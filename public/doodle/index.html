<!DOCTYPE html>
<html>
<head>
    <title>Doodle Me!</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="doodle.css">
</head>
<body>
    <div id="identification" class="component">
        <form>
            <input required id="name" type="text" placeholder="Name" />
            <input required id="roomId" type="text" placeholder="RoomId" />
            <input class="hide" type="submit" />
        </form>
    </div>
    <div id="game" class="component hide">
        <div id="users-box">

        </div>

        <div id="doodle-wrapper">
            <div class="colors">
    
            </div>
            <canvas></canvas>
            <div class="tools">
                <button id="bucket">Bucket</button>
                <button id="clear">Clear</button>
            </div>
        </div>

        <div id="chat-box">
            <form>
                <input type="text" required placeholder="talk to your friends, if any..." />
                <input type="submit" class="hide" />
            </form>
        </div>
    </div>

    <script type="text/javascript" src="doodle.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        init()
        let canvas = document.querySelector('#doodle-wrapper canvas');
        const COLORS = [
                [0, 0, 0, 255],
                [0, 0, 255, 255], 
                [0, 128, 0, 255],
                [0, 128, 128, 255],
                [0, 255, 255, 255],
                [128, 0, 128, 255],
                [255, 0, 0, 255],
                [255, 255, 0, 255],
                [255, 255, 255, 255]
        ]
        COLORS.forEach((color, index) => {
            let button = document.createElement('button');
            button.style.backgroundColor = toRgba(color);
            button.index = index;
            document.querySelector('.colors').appendChild(button)
        })
        let isHost;
        function init(){
            document.querySelector('#identification form').onsubmit = function(event){
                if(!this.checkValidity()) 
                    return;
                event.preventDefault();
                this.onkeyup = function(event){
                    if(event.keyCode == 13){
                        let name = this.querySelector('#name').value;
                        let roomId = this.querySelector('#roomId').value;
                        const socket = io('/doodleguess');
                        socket.emit('join', {
                            name: name,
                            roomId: roomId
                        })
                        socket.on('host-assigned', () => {
                            isHost = true;
                            console.log("I am host")
                        })
                        this.parentElement.classList.add('hide')
                        document.querySelector('#game').classList.remove('hide');
                        let users_box = document.querySelector('#users-box');
                        let chat_box = document.querySelector('#chat-box');

                        operateCanvas(socket);

                        socket.on('user-joined', (data) => {
                            const {users_list} = data;
                            users_box.innerHTML = '';
                            users_list.forEach((user) => {
                                let userBox = document.createElement('div');
                                userBox.classList.add('user-box');
                                userBox.textContent = user;
                                users_box.appendChild(userBox)
                            })
                        })
                        socket.on('user-left', (data) => {
                            [...users_box.children].forEach(node => {
                                if(node.textContent === data.name)
                                    node.remove()
                            })
                        })
                        socket.on('text', (data) => {
                            let chat = document.createElement('div');
                            chat.classList.add('chat');
                            chat.innerHTML = `<span style="font-style: italic; font-weight: bold">${data.sender}: </span>
                                    <span>${data.text}</span>`
                            chat_box.appendChild(chat)
                        })
                        socket.on('canvas-data', () => console.log("testing canvas-data"))
                        chat_box.querySelector('form').onsubmit  = function(event){
                            event.preventDefault();
                            socket.emit('text', {
                                text: this.querySelector('input').value
                            })
                            this.querySelector('input').value = '';
                        }
                    }
                }
            }
        }
        function operateCanvas(socket){
            let doodleCanvas = DOODLEme(canvas, {
            width: canvas.clientWidth, 
            height: canvas.clientHeight,
            colorsList: COLORS, 
            })
            let colorsBox = document.querySelector('.colors');
            colorsBox.onclick = function(event){
                colorsBox.querySelectorAll('button').forEach(el => el.classList.remove('picked'))
                let button = event.target;
                button.classList.add('picked');
                doodleCanvas.setStates({
                    colorIndex: button.index
                })
            }
            document.querySelector('#bucket').onclick = function(event){
                doodleCanvas.setStates({
                    pen: doodleCanvas.states.pen == 'stroke' ? 'fill' : 'stroke'
                });
                event.target.classList.toggle('activated');
            }
            document.querySelector('#clear').onclick = function(event){
                doodleCanvas.DRAW.clear();
            }
            
            //online canvas
            canvas.addEventListener('tip', function(event){
                if(isHost)
                    socket.emit('canvas-data', {
                        action: 'tip',
                        data: {
                            colorIndex: event.colorIndex,
                            point: event.point
                        }
                    });
            })
            canvas.addEventListener('line', function(event){
                if(isHost)
                    socket.emit('canvas-data', {
                        action: 'line',
                        data: {
                            colorIndex: event.colorIndex,
                            point: event.point
                        }
                    });
            })
            canvas.addEventListener('fill', function(event){
                if(isHost)
                    socket.emit('canvas-data', {
                        action: 'fill',
                        data: {
                            colorIndex: event.colorIndex,
                            point: event.point
                        }
                    });
            })

            socket.on('canvas-data', (canvasData) => {
                console.log("receiving canvas-data")
                const {action, data} = canvasData;
                doodleCanvas.setStates({
                    colorIndex: data.colorIndex,
                })
                switch (action){
                    case 'tip': 
                        doodleCanvas.DRAW.tip(data.point)
                        break;
                    case 'line': 
                        doodleCanvas.DRAW.line(data.point);
                        break;
                    case 'fill':
                        doodleCanvas.DRAW.scanfill(data.point);
                        break;
                }
            })
        }
    </script>

</body>
</html>